{% extends "base.html" %}
{% block title %}Editar Produto - {{ product.name }}{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow border-0">
        <div class="card-header bg-gradient text-white d-flex justify-content-between align-items-center" style="background: linear-gradient(90deg, #ffc107, #fd7e14);">
          <h4 class="mb-0"><i class="fas fa-edit me-2"></i>Editar Produto</h4>
          <a href="{{ url_for('admin_dashboard') }}" class="btn btn-light btn-sm">
            <i class="fas fa-arrow-left me-1"></i> Voltar
          </a>
        </div>

        <div class="card-body bg-light">
          <!-- Flash Messages -->
          {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
              {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                  {{ message }}
                  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
              {% endfor %}
            {% endif %}
          {% endwith %}

          <form method="POST" class="needs-validation" novalidate>
            <!-- Nome -->
            <div class="mb-3">
              <label class="form-label fw-semibold"><i class="fas fa-tag me-1"></i>Nome do Produto</label>
              <input type="text" name="name" class="form-control form-control-lg" value="{{ product.name }}" required>
            </div>

            <!-- Descrição -->
            <div class="mb-3">
              <label class="form-label fw-semibold"><i class="fas fa-align-left me-1"></i>Descrição</label>
              <textarea name="description" class="form-control" rows="3">{{ product.description }}</textarea>
            </div>

            <!-- Preço e Estoque -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label fw-semibold"><i class="fas fa-dollar-sign me-1"></i>Preço (R$)</label>
                <input type="number" step="0.01" name="price" class="form-control" value="{{ product.price }}" required>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-semibold"><i class="fas fa-warehouse me-1"></i>Estoque</label>
                <input type="number" name="stock" class="form-control" value="{{ product.stock }}">
              </div>
            </div>

            <!-- Categoria -->
            <div class="mb-3">
              <label class="form-label fw-semibold"><i class="fas fa-layer-group me-1"></i>Categoria</label>
              <select name="category_id" class="form-select">
                <option value="">Selecione...</option>
                {% for cat in categories %}
                <option value="{{ cat.id }}" {% if product.category_id == cat.id %}selected{% endif %}>{{ cat.name }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Tamanhos -->
            <div class="mb-3">
              <label class="form-label fw-semibold"><i class="fas fa-tshirt me-1"></i>Tamanhos Disponíveis</label>
              <input type="text" name="sizes" class="form-control" value="{{ product.sizes or '' }}" placeholder="Ex: P,M,G,GG (separe por vírgula)">
              <div class="form-text">Deixe vazio se o produto não tiver tamanhos (ex: acessórios).</div>
            </div>

            <!-- Cores -->
            <div class="mb-3">
              <label class="form-label fw-semibold"><i class="fas fa-palette me-1"></i>Cores Disponíveis</label>
              <input type="text" name="colors" class="form-control" value="{{ product.colors or '' }}" placeholder="Ex: Preto,Branco,Azul (separe por vírgula)">
              <div class="form-text">Deixe vazio se o produto não tiver variações de cor.</div>
            </div>

            <!-- Imagens Múltiplas -->
            <div class="mb-3">
              <label class="form-label fw-semibold"><i class="fas fa-link me-1"></i>Links das Imagens do Produto</label>

              <!-- Inputs para links de imagens -->
              <div id="url-inputs">
                {% set image_list = product.images.split(',') if product.images else [] %}
                {% for img_path in image_list %}
                <div class="input-group mb-2">
                  <input type="url" name="image_urls[]" class="form-control" value="{{ img_path }}" placeholder="https://exemplo.com/imagem.jpg">
                  <button type="button" class="btn btn-outline-danger remove-url">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
                {% if img_path %}
                <div class="mb-2">
                  <small class="text-muted">Imagem atual:</small>
                  <img src="{{ img_path }}" style="max-width: 100px; max-height: 100px;" class="ms-2" onerror="this.style.display='none'">
                </div>
                {% endif %}
                {% endfor %}
                {% if not image_list %}
                <div class="input-group mb-2">
                  <input type="url" name="image_urls[]" class="form-control" placeholder="https://exemplo.com/imagem.jpg" required>
                  <button type="button" class="btn btn-outline-danger remove-url">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
                {% endif %}
              </div>
              <button type="button" class="btn btn-outline-primary btn-sm" id="add-url">
                <i class="fas fa-plus me-1"></i>Adicionar Link de Imagem
              </button>
              <div class="form-text">Cole os links das imagens. A primeira imagem será a principal. Certifique-se de que os links sejam válidos e acessíveis.</div>
            </div>

            <!-- Opções -->
            <div class="row mb-4">
              <div class="col-md-6 form-check form-switch">
                <input class="form-check-input" type="checkbox" name="is_featured" id="featured" {% if product.is_featured %}checked{% endif %}>
                <label class="form-check-label" for="featured"><i class="fas fa-star me-1 text-warning"></i>Destaque</label>
              </div>
              <div class="col-md-6 form-check form-switch">
                <input class="form-check-input" type="checkbox" name="is_new" id="is_new" {% if product.is_new %}checked{% endif %}>
                <label class="form-check-label" for="is_new"><i class="fas fa-certificate me-1 text-success"></i>Novo</label>
              </div>
            </div>

            <!-- Botão Salvar -->
            <div class="d-grid">
              <button type="submit" class="btn btn-warning btn-lg shadow-sm text-dark fw-bold">
                <i class="fas fa-save me-2"></i>Salvar Alterações
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Validação Bootstrap
  (() => {
    'use strict'
    const forms = document.querySelectorAll('.needs-validation')
    Array.from(forms).forEach(form => {
      form.addEventListener('submit', event => {
        if (!form.checkValidity()) {
          event.preventDefault()
          event.stopPropagation()
        }
        form.classList.add('was-validated')
      }, false)
    })
  })();

  // Adicionar/remover URLs
  const addUrlBtn = document.getElementById('add-url');
  if (addUrlBtn) {
    addUrlBtn.addEventListener('click', function() {
      const urlInputs = document.getElementById('url-inputs');
      const newInput = document.createElement('div');
      newInput.className = 'input-group mb-2';
      newInput.innerHTML = `
        <input type="url" name="image_urls[]" class="form-control" placeholder="https://exemplo.com/imagem.jpg">
        <button type="button" class="btn btn-outline-danger remove-url">
          <i class="fas fa-trash"></i>
        </button>
      `;
      urlInputs.appendChild(newInput);
    });
  }

  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('remove-url') || e.target.parentElement.classList.contains('remove-url')) {
      const inputGroup = e.target.closest('.input-group');
      if (inputGroup) {
        inputGroup.remove();
      }
    }
  });
});
</script>
{% endblock %}
